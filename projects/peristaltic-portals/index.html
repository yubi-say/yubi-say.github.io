<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Peristaltic Portals</title>
	<style>
		:root {
			--bg: #07080c;
			--ink: rgba(233, 236, 255, .94);
			--muted: rgba(233, 236, 255, .62);
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			min-height: 100vh;
			background: radial-gradient(1200px 800px at 50% 30%, #101226 0%, var(--bg) 60%, #04050a 100%);
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
			color: var(--ink);
			overflow: hidden;
		}

		/* Full-bleed canvas */
		canvas {
			position: fixed;
			inset: 0;
			width: 100vw;
			height: 100vh;
			display: block;
		}

		/* Minimal HUD */
		.hud {
			position: fixed;
			left: 22px;
			right: 22px;
			top: 18px;
			display: flex;
			align-items: flex-start;
			justify-content: space-between;
			gap: 16px;
			pointer-events: none;
			/* lets canvas clicks through */
		}

		.titleBlock {
			pointer-events: auto;
			user-select: none;
		}

		.title {
			margin: 0;
			font-size: clamp(22px, 3.2vw, 40px);
			letter-spacing: -0.02em;
			font-weight: 650;
			line-height: 1.05;
		}

		.subtitle {
			margin: 8px 0 0 0;
			font-size: 12px;
			color: var(--muted);
			line-height: 1.3;
		}

		.btn {
			pointer-events: auto;
			appearance: none;
			border: 0;
			background: rgba(0, 0, 0, .22);
			color: var(--ink);
			padding: 10px 12px;
			border-radius: 999px;
			font-weight: 650;
			font-size: 12px;
			cursor: pointer;
			backdrop-filter: blur(8px);
			user-select: none;
		}

		.btn:hover {
			background: rgba(255, 255, 255, .06);
		}

		.preset {
			position: fixed;
			left: 22px;
			bottom: 18px;
			padding: 8px 10px;
			border-radius: 999px;
			background: rgba(0, 0, 0, .18);
			color: var(--muted);
			font-size: 12px;
			line-height: 1;
			backdrop-filter: blur(8px);
			user-select: none;
			pointer-events: none;
		}

		@media (max-width: 520px) {
			.hud {
				left: 14px;
				right: 14px;
				top: 14px;
			}

			.preset {
				left: 14px;
				bottom: 14px;
			}
		}
	</style>
</head>

<body>

	<canvas id="c"></canvas>

	<div class="hud">
		<div class="titleBlock">
			<h1 class="title">Peristaltic Portals</h1>
			<p class="subtitle">Tap / click anywhere to switch • Space / → also works</p>
		</div>
		<button class="btn" id="nextBtn" type="button">Next</button>
	</div>

	<div class="preset" id="presetName">03 — Peristaltic Portal</div>

	<script>
		const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const presetNameEl = document.getElementById("presetName");
  const nextBtn = document.getElementById("nextBtn");

  // Shared look/feel (same engine for all presets)
  const STYLE = {
    SPEED: 1.8,
    TRAIL: 0.10,
    LINE_W: 1.4,
    RING_W: 1.2,
    STRANDS: 4,
    R_SCALE: 0.23,
  };

  function fitCanvas(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    canvas.width  = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { w: window.innerWidth, h: window.innerHeight };
  }

  let size = fitCanvas();
  window.addEventListener("resize", () => {
    size = fitCanvas();
    clearTrail();
  });

  function clearTrail(){
    ctx.fillStyle = "rgba(7,8,12,1)";
    ctx.fillRect(0,0,size.w,size.h);
  }

  // ==================== Presets (shape-only) ====================
  const PRESETS = [
    { name: "01 — Orbit Lens",         portal: portal_orbitLens },
    { name: "02 — Ribbon Cross",       portal: portal_ribbonCross },
    { name: "03 — Peristaltic Portal", portal: portal_peristalticPortal },
    { name: "04 — Capsule",            portal: portal_capsule },
    { name: "05 — Infinity",           portal: portal_infinity },
    { name: "06 — Knot 2–3",           portal: portal_knot23 },
    { name: "07 — Wave-Square",        portal: portal_wavesquare },
    { name: "08 — Petal-5",            portal: portal_petal5 },
  ];

  // Start on #3
  let presetIndex = 2;
  presetNameEl.textContent = PRESETS[presetIndex].name;

  function nextPreset(){
    presetIndex = (presetIndex + 1) % PRESETS.length;
    presetNameEl.textContent = PRESETS[presetIndex].name;
    clearTrail(); // avoid ghosting from previous shape
  }

  nextBtn.addEventListener("click", nextPreset);

  // Tap/click anywhere switches (but keep button click working)
  window.addEventListener("pointerdown", (e) => {
    if (e.target === nextBtn) return;
    nextPreset();
  }, { passive:true });

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight" || e.key === " ") nextPreset();
  });

  // ==================== Engine (shared) ====================
  function derivNumeric(fn, u, tt, eps=1e-3){
    const p1 = fn(u, tt);
    const p2 = fn(u + eps, tt);
    return {
      x: p1.x, y: p1.y,
      dx: (p2.x - p1.x)/eps,
      dy: (p2.y - p1.y)/eps,
      wave: p1.wave ?? 0
    };
  }

  function drawStrand(portalFn, cx, cy, R, t, phase, offsetPx, alpha){
    const steps = 1100;

    ctx.beginPath();
    for(let i=0;i<=steps;i++){
      const u = (i/steps) * Math.PI*2;
      const p = derivNumeric(portalFn, u, t + phase);

      const L = Math.hypot(p.dx, p.dy) || 1;
      const nx = -p.dy / L;
      const ny =  p.dx / L;

      const off = offsetPx * (0.55 + 0.45*(0.5 + 0.5*Math.sin(u*2 + t*1.3)));

      const x = cx + (p.x*R) + nx*off;
      const y = cy + (p.y*R) + ny*off;

      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.globalAlpha = alpha;
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawSlidingRings(portalFn, cx, cy, R, t){
    const ringCount = 2;
    for(let rI=0;rI<ringCount;rI++){
      const centerU = (t*0.55 + rI*Math.PI) % (Math.PI*2);
      const span = 0.55;
      const steps = 220;

      ctx.beginPath();
      for(let i=0;i<=steps;i++){
        const a = (i/steps)*Math.PI*2;
        const u = centerU + Math.sin(a)*span;

        const p = derivNumeric(portalFn, u, t*0.85);
        const L = Math.hypot(p.dx, p.dy) || 1;
        const nx = -p.dy / L;
        const ny =  p.dx / L;

        const tanx = p.dx / L, tany = p.dy / L;
        const rr = R * 0.075 * (1 + 0.25*Math.sin(t*2 + rI));

        const x = cx + p.x*R + (nx*Math.cos(a) + tanx*Math.sin(a))*rr;
        const y = cy + p.y*R + (ny*Math.cos(a) + tany*Math.sin(a))*rr;

        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.globalAlpha = 0.65;
      ctx.lineWidth = STYLE.RING_W;
      ctx.stroke();
      ctx.globalAlpha = 1;
    }
  }

  function renderFrame(portalFn, t){
    const w = size.w, h = size.h;

    // trails
    ctx.fillStyle = `rgba(7,8,12,${STYLE.TRAIL})`;
    ctx.fillRect(0,0,w,h);

    const cx = w*0.5, cy = h*0.52;
    const R = Math.min(w,h)*STYLE.R_SCALE;

    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "rgba(233,236,255,0.92)";
    ctx.lineWidth = STYLE.LINE_W;

    const baseOff = Math.min(w,h)*0.010;
    const phases = [0.00, 0.35, 0.70, 1.05, 1.40, 1.75];
    const n = Math.max(2, Math.min(6, STYLE.STRANDS));

    for(let i=0;i<n;i++){
      const s = (i - (n-1)/2);
      const off = s * baseOff;
      const a = 0.26 + 0.14*(1 - Math.abs(s)/(n*0.6));
      drawStrand(portalFn, cx, cy, R, t, phases[i], off, a);
    }

    ctx.strokeStyle = "rgba(233,236,255,0.85)";
    drawSlidingRings(portalFn, cx, cy, R, t);
  }

  // ==================== Shapes ====================

  function portal_orbitLens(u, tt){
    const wave = 0.16*Math.sin(2*u + tt*1.35) + 0.08*Math.sin(5*u - tt*1.0);
    const r = 1.0 + wave;
    const x = r * (1.05*Math.cos(u) + 0.22*Math.cos(2*u));
    const y = r * (0.82*Math.sin(u) - 0.22*Math.sin(2*u));
    return {x,y,wave};
  }

  function portal_ribbonCross(u, tt){
    const wave = 0.14*Math.sin(2*u + tt*1.55) + 0.07*Math.sin(6*u - tt*1.05);
    const r = 1.0 + wave;
    const x = r * (Math.cos(u) + 0.30*Math.cos(3*u));
    const y = r * (Math.sin(u) + 0.30*Math.sin(3*u));
    return {x,y,wave};
  }

  function portal_peristalticPortal(u, tt){
    const k1 = 2.0, k2 = 3.0;
    const wave = 0.22*Math.sin(k1*u + tt*1.4) + 0.10*Math.sin(k2*u - tt*0.9);
    const r = 1.08 + wave;
    const x = r * (Math.cos(u) + 0.42*Math.cos(3*u));
    const y = r * (Math.sin(u) - 0.42*Math.sin(3*u));
    return {x,y,wave};
  }

  function portal_capsule(u, tt){
    const k1 = 2.0, k2 = 3.0;
    const wave = 0.16*Math.sin(k1*u + tt*1.5) + 0.08*Math.sin(k2*u - tt*1.0);
    const r = 1.0 + wave;

    const a = 1.12, b = 0.78;
    const p = 2.7;
    const cu = Math.cos(u), su = Math.sin(u);

    const x = r * a * Math.sign(cu) * Math.pow(Math.abs(cu), 2/p);
    const y = r * b * Math.sign(su) * Math.pow(Math.abs(su), 2/p);
    return {x,y,wave};
  }

  function portal_infinity(u, tt){
    const k1 = 2.0, k2 = 3.0;
    const wave = 0.16*Math.sin(k1*u + tt*1.6) + 0.08*Math.sin(k2*u - tt*1.0);
    const r = 1.0 + wave;
    const x = r * Math.cos(u);
    const y = r * Math.sin(u) * Math.cos(u);
    return {x,y,wave};
  }

  function portal_knot23(u, tt){
    const k1 = 2.0, k2 = 3.0;
    const wave = 0.14*Math.sin(k1*u + tt*1.4) + 0.07*Math.sin(k2*u - tt*1.0);

    const p = 2, q = 3;
    const a = 1.0 + 0.22*Math.cos(q*u + tt*0.9) + wave;
    const x = a * Math.cos(p*u);
    const y = a * Math.sin(p*u);
    return {x,y,wave};
  }

  function portal_wavesquare(u, tt){
    const wave = 0.14*Math.sin(2*u + tt*1.5) + 0.08*Math.sin(6*u - tt*1.1);
    const r = 1.0 + wave;

    const cu = Math.cos(u), su = Math.sin(u);
    const p = 4.2;
    const x = r * Math.sign(cu) * Math.pow(Math.abs(cu), 2/p);
    const y = r * Math.sign(su) * Math.pow(Math.abs(su), 2/p);
    return {x,y,wave};
  }

  function portal_petal5(u, tt){
    const wave = 0.12*Math.sin(2*u + tt*1.5) + 0.06*Math.sin(3*u - tt*1.0);
    const m = 5;
    const r = 1.0 + 0.22*Math.cos(m*u + tt*1.0) + wave;
    const x = r * Math.cos(u);
    const y = r * Math.sin(u);
    return {x,y,wave};
  }

  // ==================== Run ====================
  clearTrail();

  let t = 0;
  function tick(){
    const portalFn = PRESETS[presetIndex].portal;
    renderFrame(portalFn, t);
    t += 0.016 * STYLE.SPEED;
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
	</script>
</body>

</html>
